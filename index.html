<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <title>Fritz Popis</title>
    
    <link rel="icon" type="image/jpeg" href="https://i.postimg.cc/hvYhRsLJ/01_Wide_version_for_white_background.jpg">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/hvYhRsLJ/01_Wide_version_for_white_background.jpg">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f6f8;
            color: #333;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            background-color: #ffffff;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            height: 35px;
            width: auto;
            margin-right: 10px;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            color: #24292e;
        }

        /* DUGMIƒÜI ZA PROMENU MODA */
        .mode-switch {
            display: flex;
            background: #e1e4e8;
            border-radius: 8px;
            padding: 4px;
            margin: 15px 20px 0 20px; /* Malo odvojeno od headera */
        }

        .mode-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #586069;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background-color: white;
            color: #0366d6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* GLAVNI DEO */
        main {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 500px;
        }

        /* KAMERA KONTEJNER (Sakriven po defaultu) */
        #reader {
            width: 100%;
            display: none; /* Sakriveno dok se ne izabere mobilni mod */
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        .form-group { margin-bottom: 15px; }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: #586069;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px; /* Malo veƒái padding za prste */
            border: 1px solid #d1d5da;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: white;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #0366d6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.3);
        }

        /* Zeleno dugme */
        button.btn-primary {
            background-color: #2ea44f;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        button.btn-primary:active { background-color: #2c974b; transform: scale(0.98); }

        /* Status poruke */
        #statusMessage {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            display: none;
            text-align: center;
        }
        .success { background-color: #dcffe4; color: #1a7f37; border: 1px solid #bef5cb; }
        .error { background-color: #ffebe9; color: #cf222e; border: 1px solid #ffc1bc; }

    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="https://i.postimg.cc/hvYhRsLJ/01_Wide_version_for_white_background.jpg" alt="Logo" class="logo">
            <h1>Fritz Popis</h1>
        </div>
    </header>

    <div class="mode-switch">
        <button class="mode-btn" id="btn-mobilni" onclick="setMode('mobilni')">üì∑ Mobilni</button>
        <button class="mode-btn active" id="btn-skener" onclick="setMode('skener')">üî´ Skener</button>
    </div>

    <main>
        <div class="card">
            <div id="reader"></div>

            <div class="form-group">
                <label for="lokacija">Lokacija:</label>
                <select id="lokacija">
                    <option value="" disabled selected>-- Izaberi lokaciju --</option>
                    <option value="Magacin 1">Magacin 1</option>
                    <option value="Magacin 2">Magacin 2</option>
                    <option value="Magacin 3">Magacin 3</option>
                    <option value="Magacin 4">Magacin 4</option>
                </select>
            </div>

            <div class="form-group">
                <label for="kod">Bar-kod:</label>
                <input type="text" id="kod" placeholder="Skeniraj..." autocomplete="off">
            </div>

            <div class="form-group">
                <label for="kolicina">Koliƒçina:</label>
                <input type="number" id="kolicina" placeholder="Koliƒçina">
            </div>

            <div class="form-group">
                <label for="napomena">Napomena:</label>
                <textarea id="napomena" rows="2" placeholder="Opciono..."></textarea>
            </div>

            <button class="btn-primary" onclick="saveData()">Saƒçuvaj Unos</button>
            <div id="statusMessage"></div>
        </div>
    </main>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8coit4C-MckbtGspSJ0QtMboldH0BrGzsAa5oknFyuQ1c_Grufk4S_zyfQ8xjGf0lOQ/exec'; 
        
        let html5QrcodeScanner = null;
        let currentMode = 'skener';
        
        // --- NOVO: Zastavica koja spreƒçava dupli upis ---
        let isSubmitting = false; 

        window.onload = function() {
            document.getElementById("kod").focus();
            proveriOfflinePodatke(); 
        };

        // === ENTER LOGIKA ===
        document.addEventListener('keydown', function(event) {
            // Ako je slanje u toku, ignori≈°i BILO KAKAV taster (Enter, kucanje...)
            if (isSubmitting) {
                event.preventDefault();
                return;
            }

            if (event.key === 'Enter' || event.keyCode === 13) {
                const aktivnoPolje = document.activeElement;
                
                if (aktivnoPolje.id === 'kod') {
                    event.preventDefault();
                    if (document.getElementById('kod').value.trim() === "") return;
                    
                    const poljeKolicina = document.getElementById('kolicina');
                    poljeKolicina.focus();
                    poljeKolicina.select(); 
                } 
                else if (aktivnoPolje.id === 'kolicina') {
                    event.preventDefault();
                    saveData();
                }
            }
        });

        // === GLAVNA FUNKCIJA ƒåUVANJA ===
        async function saveData() {
            // 1. BEZBEDNOSNA PROVERA: Ako veƒá ≈°aljem, be≈æi napolje!
            if (isSubmitting) return;

            const lokacija = document.getElementById('lokacija').value;
            const kod = document.getElementById('kod').value;
            const kolicina = document.getElementById('kolicina').value;
            const napomena = document.getElementById('napomena').value;

            if (!lokacija) { prikaziStatus("Izaberi lokaciju!", "error"); return; }
            if (!kod) { prikaziStatus("Fali bar-kod!", "error"); document.getElementById('kod').focus(); return; }
            if (!kolicina) { prikaziStatus("Unesi koliƒçinu!", "error"); document.getElementById('kolicina').focus(); return; }

            // 2. ZAKLJUƒåAVANJE: Di≈æemo zastavicu i blokiramo polja
            isSubmitting = true;
            toggleInputs(false); // Funkcija koja gasi polja (vidi dole)

            const podaci = { lokacija, naziv: kod, kolicina, napomena };

            prikaziStatus("‚è≥ Slanje...", "success");

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(podaci)
                });

                prikaziStatus("‚úÖ Upisano: " + kod, "success");
                
                // Oƒçisti polja
                document.getElementById('kod').value = '';
                document.getElementById('kolicina').value = ''; 
                document.getElementById('napomena').value = '';

            } catch (error) {
                sacuvajLokalno(podaci);
                prikaziStatus("Nema neta. Saƒçuvano u telefonu.", "error");
                
                // I ovde ƒçistimo da bi mogao dalje da radi≈°
                document.getElementById('kod').value = '';
                document.getElementById('kolicina').value = '';
            } finally {
                // 3. OTKLJUƒåAVANJE: Bilo uspe≈°no ili ne, ovde zavr≈°avamo
                isSubmitting = false;
                toggleInputs(true); // Pali polja
                document.getElementById('kod').focus(); // Vrati fokus za novi sken
            }
        }

        // --- POMOƒÜNA FUNKCIJA ZA BLOKIRANJE POLJA ---
        function toggleInputs(omoguceno) {
            document.getElementById('kod').disabled = !omoguceno;
            document.getElementById('kolicina').disabled = !omoguceno;
            document.getElementById('napomena').disabled = !omoguceno;
            // Ako je onemoguƒáeno, promeni boju pozadine da korisnik vidi
            const boja = omoguceno ? 'white' : '#e9ecef';
            document.getElementById('kod').style.backgroundColor = boja;
            document.getElementById('kolicina').style.backgroundColor = boja;
        }

        // === OSTALE FUNKCIJE (Offline, Kamera...) ===
        function proveriOfflinePodatke() {
            const offlineData = JSON.parse(localStorage.getItem('offlineSkenovi')) || [];
            const syncDiv = document.getElementById('statusMessage');
            if (offlineData.length > 0 && (!syncDiv.style.display || syncDiv.style.display === 'none')) {
                syncDiv.innerHTML = `<div style="background:#fff3cd; color:#856404; padding:10px;">‚ö†Ô∏è Nesaƒçuvano: ${offlineData.length}. <button onclick="sinhronizuj()">Po≈°alji</button></div>`;
                syncDiv.style.display = 'block';
            }
        }

        function sacuvajLokalno(podaci) {
            let offlineData = JSON.parse(localStorage.getItem('offlineSkenovi')) || [];
            offlineData.push(podaci);
            localStorage.setItem('offlineSkenovi', JSON.stringify(offlineData));
            proveriOfflinePodatke();
        }

        async function sinhronizuj() {
            let offlineData = JSON.parse(localStorage.getItem('offlineSkenovi')) || [];
            if (offlineData.length === 0) return;
            prikaziStatus("≈†aljem...", "success");
            let preostalo = [];
            for (let item of offlineData) {
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(item) });
                } catch (e) { preostalo.push(item); }
                await new Promise(r => setTimeout(r, 300));
            }
            localStorage.setItem('offlineSkenovi', JSON.stringify(preostalo));
            if (preostalo.length === 0) { prikaziStatus("Sve sinhronizovano!", "success"); setTimeout(()=>document.getElementById('statusMessage').style.display='none', 3000); }
            else { proveriOfflinePodatke(); }
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + mode).classList.add('active');
            if (mode === 'mobilni') { document.getElementById('reader').style.display = 'block'; pokreniKameru(); }
            else { document.getElementById('reader').style.display = 'none'; zaustaviKameru(); document.getElementById("kod").focus(); }
        }

        function pokreniKameru() {
            if (html5QrcodeScanner) return;
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 300, height: 150 }, aspectRatio: 1.0 };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
        }
        function zaustaviKameru() { if (html5QrcodeScanner) { html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); html5QrcodeScanner = null; }); } }
        
        function onScanSuccess(decodedText) {
            document.getElementById('kod').value = decodedText;
            document.getElementById('kolicina').focus();
        }
        function onScanFailure(error) {}

        function prikaziStatus(poruka, tip) {
            const statusDiv = document.getElementById('statusMessage');
            if (tip === 'success') {
                statusDiv.innerHTML = `<div class="${tip}" style="font-weight:bold; font-size:1.2em;">${poruka}</div>`;
            } else {
                statusDiv.innerHTML = `<div class="${tip}">${poruka}</div>`;
            }
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html>







