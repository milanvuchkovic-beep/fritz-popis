<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <title>Fritz Popis</title>
    
    <link rel="icon" type="image/jpeg" href="https://i.postimg.cc/hvYhRsLJ/01_Wide_version_for_white_background.jpg">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/hvYhRsLJ/01_Wide_version_for_white_background.jpg">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f6f8;
            color: #333;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            background-color: #ffffff;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            height: 35px;
            width: auto;
            margin-right: 10px;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            color: #24292e;
        }

        /* DUGMI캕I ZA PROMENU MODA */
        .mode-switch {
            display: flex;
            background: #e1e4e8;
            border-radius: 8px;
            padding: 4px;
            margin: 15px 20px 0 20px; /* Malo odvojeno od headera */
        }

        .mode-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #586069;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background-color: white;
            color: #0366d6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* GLAVNI DEO */
        main {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 500px;
        }

        /* KAMERA KONTEJNER (Sakriven po defaultu) */
        #reader {
            width: 100%;
            display: none; /* Sakriveno dok se ne izabere mobilni mod */
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        .form-group { margin-bottom: 15px; }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: #586069;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px; /* Malo ve캖i padding za prste */
            border: 1px solid #d1d5da;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: white;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #0366d6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.3);
        }

        /* Zeleno dugme */
        button.btn-primary {
            background-color: #2ea44f;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        button.btn-primary:active { background-color: #2c974b; transform: scale(0.98); }

        /* Status poruke */
        #statusMessage {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            display: none;
            text-align: center;
        }
        .success { background-color: #dcffe4; color: #1a7f37; border: 1px solid #bef5cb; }
        .error { background-color: #ffebe9; color: #cf222e; border: 1px solid #ffc1bc; }

    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="https://i.postimg.cc/hvYhRsLJ/01_Wide_version_for_white_background.jpg" alt="Logo" class="logo">
            <h1>Fritz Popis</h1>
        </div>
    </header>

    <div class="mode-switch">
        <button class="mode-btn" id="btn-mobilni" onclick="setMode('mobilni')">游닝 Mobilni</button>
        <button class="mode-btn active" id="btn-skener" onclick="setMode('skener')">游댦 Skener</button>
    </div>

    <main>
        <div class="card">
            <div id="reader"></div>

            <div class="form-group">
                <label for="lokacija">Lokacija:</label>
                <select id="lokacija">
                    <option value="" disabled selected>-- Izaberi lokaciju --</option>
                    <option value="Magacin 1">Magacin 1</option>
                    <option value="Magacin 2">Magacin 2</option>
                    <option value="Proizvodnja">Proizvodnja</option>
                    <option value="Dvori코te">Dvori코te</option>
                </select>
            </div>

            <div class="form-group">
                <label for="kod">Bar-kod:</label>
                <input type="text" id="kod" placeholder="Skeniraj..." autocomplete="off">
            </div>

            <div class="form-group">
                <label for="kolicina">Koli캜ina:</label>
                <input type="number" id="kolicina" placeholder="Koli캜ina">
            </div>

            <div class="form-group">
                <label for="napomena">Napomena:</label>
                <textarea id="napomena" rows="2" placeholder="Opciono..."></textarea>
            </div>

            <button class="btn-primary" onclick="saveData()">Sa캜uvaj Unos</button>
            <div id="statusMessage"></div>
        </div>
    </main>

    <script>
        // === PODEㅁVANJA ===
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8coit4C-MckbtGspSJ0QtMboldH0BrGzsAa5oknFyuQ1c_Grufk4S_zyfQ8xjGf0lOQ/exec'; 
        let html5QrcodeScanner = null;
        let currentMode = 'skener';

        // === INICIJALIZACIJA ===
        window.onload = function() {
            // Po defaultu smo u skener modu
            document.getElementById("kod").focus();
        };

        // === PROMENA MODA RADA ===
        function setMode(mode) {
            currentMode = mode;
            
            // A쬿riraj dugmi캖e
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + mode).classList.add('active');

            if (mode === 'mobilni') {
                document.getElementById('reader').style.display = 'block';
                pokreniKameru();
            } else {
                document.getElementById('reader').style.display = 'none';
                zaustaviKameru();
                document.getElementById("kod").focus();
            }
        }

        // === LOGIKA ZA KAMERU ===
        function pokreniKameru() {
            if (html5QrcodeScanner) return; // Ve캖 radi

            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrcodeScanner.start(
                { facingMode: "environment" }, // Zadnja kamera
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Gre코ka kamere", err);
                prikaziStatus("Ne mogu da pristupim kameri. Proveri dozvole.", "error");
            });
        }

        function zaustaviKameru() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.error(err));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Uspe코an sken kamerom
            console.log(`Code matched = ${decodedText}`, decodedResult);
            
            // Popuni polje
            document.getElementById('kod').value = decodedText;
            
            // Zvu캜ni signal (opciono, browseri nekad blokiraju)
            // beep(); 

            // Zaustavi kameru da ne skenira isti kod 100 puta
            // Ili samo pauziraj? Za sada ne prekidamo kameru skroz, ali fokusiramo koli캜inu.
            // Ako 쬰li코 da se kamera ugasi posle skena, otkomentari코i liniju ispod:
            // zaustaviKameru(); setMode('skener'); // Ovo bi vratilo na manuelni mod

            document.getElementById('kolicina').focus();
            prikaziStatus("Skenirano: " + decodedText, "success");
        }

        function onScanFailure(error) {
            // Ignorisanje gre코aka dok tra쬴 kod, da ne puni konzolu
        }

        // === LOGIKA ZA ENTER TASTER (ZA SKENER MOD) ===
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const aktivnoPolje = document.activeElement;
                
                if (aktivnoPolje.id === 'kod') {
                    event.preventDefault();
                    document.getElementById('kolicina').focus();
                } else if (aktivnoPolje.id === 'kolicina') {
                    event.preventDefault();
                    saveData();
                }
            }
        });

        // === SLANJE PODATAKA ===
        async function saveData() {
            const lokacija = document.getElementById('lokacija').value;
            const kod = document.getElementById('kod').value;
            const kolicina = document.getElementById('kolicina').value;
            const napomena = document.getElementById('napomena').value;

            if (!lokacija) { prikaziStatus("Izaberi lokaciju!", "error"); return; }
            if (!kod) { prikaziStatus("Fali bar-kod!", "error"); document.getElementById('kod').focus(); return; }
            if (!kolicina) { prikaziStatus("Unesi koli캜inu!", "error"); document.getElementById('kolicina').focus(); return; }

            const podaci = {
                lokacija: lokacija,
                naziv: kod,
                kolicina: kolicina,
                napomena: napomena
            };

            prikaziStatus("마ljem...", "success");

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(podaci)
                });

                prikaziStatus("Upisano: " + kod, "success");

                // Reset
                document.getElementById('kod').value = '';
                document.getElementById('kolicina').value = '';
                document.getElementById('napomena').value = '';

                // Gde se vra캖a fokus zavisi od moda
                if (currentMode === 'skener') {
                    document.getElementById('kod').focus();
                } else {
                    // Ako je kamera, ona i dalje radi, samo 캜ekamo novi kod
                    document.getElementById('kod').placeholder = "Skeniraj slede캖i...";
                }

            } catch (error) {
                prikaziStatus("Gre코ka: " + error.message, "error");
            }
        }

        function prikaziStatus(poruka, tip) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = poruka;
            statusDiv.className = tip;
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html>
